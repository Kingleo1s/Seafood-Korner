
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Your Cart | Seafood Korner</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<header>
    <h1>üõí Your Cart</h1>
    <nav>
        <a href="/">Home</a> |
        <a href="/menu/">Menu</a> |
        <a href="/cart/">Cart</a>
    </nav>
</header>

<main>
{% if cart_items %}
    <table class="cart-table">
        <thead>
            <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        {% for item in cart_items %}
            <tr id="row-{{ item.menu_item.id }}">
                <td>{{ item.menu_item.name }}</td>
                <td>
                    <button class="qty-btn" data-id="{{ item.menu_item.id }}" data-action="decrease">‚àí</button>
                    <span id="qty-{{ item.menu_item.id }}">{{ item.quantity }}</span>
                    <button class="qty-btn" data-id="{{ item.menu_item.id }}" data-action="increase">+</button>
                </td>
                <td>‚Ç¶{{ item.menu_item.price }}</td>
                <td id="item-total-{{ item.menu_item.id }}">‚Ç¶{{ item.menu_item.price|floatformat:2|add:item.menu_item.price|floatformat:2 }}</td>
                <td><button class="remove-btn" data-id="{{ item.menu_item.id }}">‚ùå Remove</button></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <div class="cart-total">
        <h3>Total: ‚Ç¶<span id="cart-total">{{ total }}</span></h3>
        <form method="POST" action="{% url 'checkout' %}">
            {% csrf_token %}
            <button class="checkout-btn" type="submit">Proceed to Checkout</button>
        </form>
    </div>
{% else %}
    <p>Your cart is empty. <a href="/menu/">Go back to menu</a>.</p>
{% endif %}
</main>

<footer>
    <p>¬© 2025 Seafood Korner | Fresh Taste Everyday</p>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Handle quantity updates
    const qtyButtons = document.querySelectorAll(".qty-btn");
    qtyButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const itemId = btn.dataset.id;
            const action = btn.dataset.action;
            const csrfToken = "{{ csrf_token }}";

            fetch("{% url 'update_cart_quantity' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken,
                },
                body: `item_id=${itemId}&action=${action}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.quantity !== undefined) {
                    document.getElementById(`qty-${itemId}`).textContent = data.quantity;
                    document.getElementById(`item-total-${itemId}`).textContent = `‚Ç¶${data.item_total.toFixed(2)}`;
                    document.getElementById("cart-total").textContent = data.cart_total.toFixed(2);
                }
            })
            .catch(err => console.error("Error:", err));
        });
    });

    // Handle removal
    const removeButtons = document.querySelectorAll(".remove-btn");
    removeButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const itemId = btn.dataset.id;
            fetch("{% url 'remove_from_cart' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: `item_id=${itemId}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    document.getElementById(`row-${itemId}`).remove();
                    alert(data.message);
                }
            });
        });
    });
});
</script>
</body>
</html>
